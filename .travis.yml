language: csharp
dist: xenial
mono: none
dotnet: 3.1

addons:
  apt:
    packages:
    - tree
    - maven

install:
 - git clone --depth 1 --shallow-submodules https://github.com/health-validator/org.hl7.fhir.core
 - cd org.hl7.fhir.core
 - git rev-parse HEAD
 - mvn package -Dmaven.test.skip=true --projects org.hl7.fhir.validation.cli
 - mv org.hl7.fhir.validation.cli/target/org.hl7.fhir.validation.cli*-SNAPSHOT.jar $TRAVIS_BUILD_DIR/org.hl7.fhir.validator.jar
 - cd $TRAVIS_BUILD_DIR
 # verify the version of the validator we've built
 - java -jar org.hl7.fhir.validator.jar
 - sed -i 's|// import appmodel 1.0|import appmodel 1.0|g' Main.qml

script:
 - dotnet publish --configuration Release --runtime linux-x64
 - dotnet publish --configuration Release --runtime osx-x64

after_success:
 - cd bin/Release/netcoreapp3.0
 - tree .
 - cd linux-x64/publish && rm -f createdump && zip -r Hammer-linux.zip * && mv Hammer-linux.zip ../../ && cd ../../
 - cd osx-x64/publish && rm -f createdump && zip -r Hammer-osx.zip * && mv Hammer-osx.zip ../../ && cd ../../
 - rm -rf linux-x64/ osx-x64/
 - DEPLOY_URL=$(curl --upload-file ./Hammer-linux.zip https://transfer.sh/Hammer-linux.zip)
 - echo -e "Linux zip is available for download at $DEPLOY_URL"

deploy:
  provider: pages
  repo: health-validator/latest
  target_branch: master
  local_dir: bin/Release/netcoreapp3.0
  skip_cleanup: true
  github_token: $GITHUB_TOKEN
  keep_history: false
  verbose: true
  on:
    branch: master

cache:
  directories:
  - $HOME/.m2

env:
  global:
    secure: UcLqWcGZCRMQPKTNcVFJjWCzYaOSyc2TfdhwZnMZqzHHth/3SY8D56JniS/DBagTzZ/H+eqbDkwa9DHJLQ4oxJB8jgwNuXnHjekQiDcUVEhKh0Tc2KUbMY6anRyx05wPloEurFbekXQTI2FUKS6bEpHyFYsPvc9aJXWnujd1Ge1OOyWN3n6+KuMOM/lemyljk5iGbGke1TWPyJ8SnpcVrKYLxle9Bvn5E4q5XOqf7aFSTTwy4kzS81fpl7X2SIlh8XfT4npZ9U09mYDGN3+ZSdkq6QA+fXdi49qyaGaTSAVPodLQ1Sa1FEesZZcBoVSBBERt0FYjs25SgJdj6FClrmtiN8CCTMPBJvfQvxlIQ+SWHFXrIXxNMVct5CxApmsfkuyVovyMGNakGTgWLzgwBGKrzE6qRh5ea6OXtg0dHkXPKmZ9bQZNt3Fzz75T+aQUqsVqsXfHfK1m/e/RLYUPkjZLzTKPo+RPQqO0PPgIIVa9ir56LPqMzJPypKCNddleOZpvLHaS3LEmckVRAFUUHZpdbQGzMIwNisZDqOo64Tc9FflZRPdfTdAsgBq9nWbIlxeNZbq76OQ4tlJlexaXMTV9NEVCaHFNZ1+Rnu2zunR+bYfXxWdoLhiZ15ldn5jSjYZol9uPwhn194/uOO3Rkp7LRm1nOSTSW6lJo9Y8SLU=
